# Help Digi School - GitLab CI/CD Configuration
# Stages: Quality Check, Build Environments, and Makefile Validation

stages:
  - quality
  - build
  - test

variables:
  NODE_IMAGE: node:20-alpine
  DOCKER_DRIVER: overlay2

# Cache configurations for faster jobs
cache:
  paths:
    - .npm/

# ============================================
# QUALITY STAGE
# ============================================

lint:
  image: $NODE_IMAGE
  stage: quality
  before_script:
    - npm ci --cache .npm --prefer-offline --legacy-peer-deps
  script:
    - npm run lint

type-check:
  image: $NODE_IMAGE
  stage: quality
  before_script:
    - npm ci --cache .npm --prefer-offline --legacy-peer-deps
  script:
    - npx tsc --noEmit

# ============================================
# BUILD STAGE (Environment Testing)
# ============================================

.build_template:
  image: $NODE_IMAGE
  stage: build
  before_script:
    - npm ci --cache .npm --prefer-offline --legacy-peer-deps
  script:
    - npm run build

build:dev:
  extends: .build_template
  variables:
    NEXT_PUBLIC_ENVIRONMENT: development
    NEXT_PUBLIC_API_URL: http://localhost:8080/api/v1

build:preprod:
  extends: .build_template
  variables:
    NEXT_PUBLIC_ENVIRONMENT: preprod
    NEXT_PUBLIC_API_URL: https://api-preprod.helpdigischool.com/api/v1

build:prod:
  extends: .build_template
  variables:
    NEXT_PUBLIC_ENVIRONMENT: production
    NEXT_PUBLIC_API_URL: https://api.helpdigischool.com/api/v1

# ============================================
# TEST STAGE (Makefile Validation)
# ============================================

test:makefile:
  image: alpine:latest
  stage: test
  before_script:
    - apk add --no-cache make bash
  script:
    - echo "Testing Makefile targets..."
    - make version
    - make help
    - make status
    - echo "Makefile logic validated"
# Note: Pour tester r√©ellement le build Docker en CI,
# il faudrait utiliser un runner avec Docker-in-Docker.

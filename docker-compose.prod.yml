# ============================================
# Help Digi School - Production
# ============================================
# Usage: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
# ============================================

x-logging-loki: &loki-logging
  driver: loki
  options:
    loki-url: "${LOKI_URL:-http://loki:3100/loki/api/v1/push}"
    loki-batch-size: "400"
    loki-retries: "5"
    loki-timeout: "10s"
    loki-tenant-id: "helpdigischool"
    loki-external-labels: "job=helpdigischool-frontend,environment=production"

services:
  frontend:
    build:
      target: production
      cache_from:
        - ${DOCKER_REGISTRY:-}helpdigischool/frontend:latest
    image: ${DOCKER_REGISTRY:-}helpdigischool/frontend:${VERSION:-latest}
    container_name: helpdigischool-frontend-prod
    restart: always
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    environment:
      - NODE_ENV=production
      - ENVIRONMENT=production
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - NEXT_PUBLIC_APP_NAME=${NEXT_PUBLIC_APP_NAME:-Help Digi School}
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL}
      - NEXT_PUBLIC_ENVIRONMENT=production
    env_file:
      - .env.production
    networks:
      - default
      - monitoring
      - traefik
    deploy:
      mode: replicated
      replicas: 2
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      update_config:
        parallelism: 1
        delay: 30s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 10s
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      # Traefik
      - "traefik.enable=true"
      - "traefik.http.routers.helpdigischool-prod.rule=Host(`helpdigischool.com`) || Host(`www.helpdigischool.com`)"
      - "traefik.http.routers.helpdigischool-prod.entrypoints=websecure"
      - "traefik.http.routers.helpdigischool-prod.tls=true"
      - "traefik.http.routers.helpdigischool-prod.tls.certresolver=letsencrypt"
      - "traefik.http.services.helpdigischool-prod.loadbalancer.server.port=3000"
      - "traefik.http.services.helpdigischool-prod.loadbalancer.healthcheck.path=/api/health"
      - "traefik.http.services.helpdigischool-prod.loadbalancer.healthcheck.interval=10s"
      - "traefik.http.services.helpdigischool-prod.loadbalancer.sticky.cookie=true"
      - "traefik.http.services.helpdigischool-prod.loadbalancer.sticky.cookie.name=helpdigischool_sticky"
      # Redirect www to non-www
      - "traefik.http.routers.helpdigischool-www.rule=Host(`www.helpdigischool.com`)"
      - "traefik.http.routers.helpdigischool-www.entrypoints=websecure"
      - "traefik.http.routers.helpdigischool-www.middlewares=www-redirect@docker"
      - "traefik.http.middlewares.www-redirect.redirectregex.regex=^https://www\\.(.+)"
      - "traefik.http.middlewares.www-redirect.redirectregex.replacement=https://$${1}"
      - "traefik.http.middlewares.www-redirect.redirectregex.permanent=true"
      # Security Middlewares
      - "traefik.http.routers.helpdigischool-prod.middlewares=security-headers-prod@docker,rate-limit-prod@docker,compress@docker"
      - "traefik.http.middlewares.security-headers-prod.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.security-headers-prod.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.security-headers-prod.headers.stsPreload=true"
      - "traefik.http.middlewares.security-headers-prod.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.security-headers-prod.headers.browserXssFilter=true"
      - "traefik.http.middlewares.security-headers-prod.headers.referrerPolicy=strict-origin-when-cross-origin"
      - "traefik.http.middlewares.security-headers-prod.headers.permissionsPolicy=camera=(), microphone=(), geolocation=()"
      - "traefik.http.middlewares.rate-limit-prod.ratelimit.average=50"
      - "traefik.http.middlewares.rate-limit-prod.ratelimit.burst=100"
      - "traefik.http.middlewares.rate-limit-prod.ratelimit.period=1s"
      - "traefik.http.middlewares.compress.compress=true"
      # Monitoring
      - "prometheus.scrape=true"
      - "prometheus.port=3000"
      - "prometheus.path=/api/metrics"
      # Info
      - "com.helpdigischool.environment=production"
    logging: *loki-logging

  # Redis pour sessions/cache
  redis:
    image: redis:7-alpine
    container_name: helpdigischool-redis-prod
    restart: always
    command: >
      redis-server
      --appendonly yes
      --maxmemory 1gb
      --maxmemory-policy allkeys-lru
      --requirepass ${REDIS_PASSWORD}
      --tcp-backlog 511
      --tcp-keepalive 300
    volumes:
      - redis-data:/data
    networks:
      - default
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    profiles:
      - with-redis

  # Nginx Reverse Proxy (Alternative Ã  Traefik)
  nginx:
    image: nginx:alpine
    container_name: helpdigischool-nginx-prod
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
    depends_on:
      frontend:
        condition: service_healthy
    networks:
      - default
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 256M
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3
    profiles:
      - with-nginx

networks:
  default:
    name: helpdigischool-network-prod
    driver: bridge
  monitoring:
    external: true
    name: monitoring-network
  traefik:
    external: true
    name: traefik

volumes:
  redis-data:
    name: helpdigischool-redis-prod

# ============================================
# Help Digi School - Dockerfile DEVELOPMENT
# ============================================
# Usage: docker build -f docker/Dockerfile.dev -t helpdigischool/frontend:dev .
# ============================================

ARG NODE_VERSION=20

FROM node:${NODE_VERSION}-alpine

LABEL maintainer="HelpDigiSchool Team <contact@helpdigischool.cm>"
LABEL description="Help Digi School Frontend - Development"
LABEL environment="development"

# Dépendances système
RUN apk update && apk add --no-cache \
    libc6-compat \
    curl \
    wget \
    git \
    && rm -rf /var/cache/apk/*

# Configuration npm
RUN npm config set fund false && \
    npm config set audit false

WORKDIR /app

# Copie des fichiers de dépendances
COPY package.json yarn.lock* package-lock.json* pnpm-lock.yaml* ./

# Installation des dépendances
RUN if [ -f package-lock.json ]; then \
        npm ci --legacy-peer-deps; \
    elif [ -f yarn.lock ]; then \
        corepack enable && yarn install --frozen-lockfile; \
    elif [ -f pnpm-lock.yaml ]; then \
        corepack enable && pnpm install --frozen-lockfile; \
    else \
        npm install --legacy-peer-deps; \
    fi

# Copie du code source
COPY . .

# Variables d'environnement
ENV NODE_ENV=development \
    NEXT_TELEMETRY_DISABLED=1 \
    WATCHPACK_POLLING=true \
    CHOKIDAR_USEPOLLING=true \
    PORT=3000

# Ports
EXPOSE 3000
EXPOSE 9229

# Healthcheck (plus tolérant en dev)
HEALTHCHECK --interval=60s --timeout=15s --start-period=120s --retries=5 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:3000 || exit 1

# Commande de démarrage
CMD ["npm", "run", "dev"]
# ============================================
# Help Digi School - Pre-Production
# ============================================
# Usage: docker-compose -f docker-compose.yml -f docker-compose.preprod.yml up -d
# ============================================


services:
  frontend:
    build:
      target: production
      cache_from:
        - ${DOCKER_REGISTRY:-}helpdigischool/frontend:preprod-latest
    image: ${DOCKER_REGISTRY:-}helpdigischool/frontend:preprod-${VERSION:-latest}
    container_name: helpdigischool-frontend-preprod
    restart: always
    ports:
      - "${FRONTEND_PORT:-32031}:3000"
    environment:
      - NODE_ENV=production
      - ENVIRONMENT=preprod
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - NEXT_PUBLIC_APP_NAME=${NEXT_PUBLIC_APP_NAME:-Help Digi School}
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL}
      - NEXT_PUBLIC_ENVIRONMENT=preprod
    env_file:
      - .env.preprod
    networks:
      - default
      - traefik
    deploy:
      mode: replicated
      replicas: 1
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          cpus: '2'
          memory: 2G
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      # Traefik
      - "traefik.enable=true"
      - "traefik.http.routers.helpdigischool-preprod.rule=Host(`preprod.helpdigischool.com`)"
      - "traefik.http.routers.helpdigischool-preprod.entrypoints=websecure"
      - "traefik.http.routers.helpdigischool-preprod.tls=true"
      - "traefik.http.routers.helpdigischool-preprod.tls.certresolver=letsencrypt"
      - "traefik.http.services.helpdigischool-preprod.loadbalancer.server.port=3000"
      - "traefik.http.services.helpdigischool-preprod.loadbalancer.healthcheck.path=/api/health"
      - "traefik.http.services.helpdigischool-preprod.loadbalancer.healthcheck.interval=10s"
      # Middlewares
      - "traefik.http.routers.helpdigischool-preprod.middlewares=security-headers-preprod@docker,rate-limit-preprod@docker"
      - "traefik.http.middlewares.security-headers-preprod.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.security-headers-preprod.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.security-headers-preprod.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.security-headers-preprod.headers.browserXssFilter=true"
      - "traefik.http.middlewares.rate-limit-preprod.ratelimit.average=100"
      - "traefik.http.middlewares.rate-limit-preprod.ratelimit.burst=50"
      # Info
      - "com.helpdigischool.environment=preprod"
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
        tag: "{{.Name}}"

networks:
  default:
    name: helpdigischool-network-preprod
    driver: bridge
  traefik:
    external: true
    name: traefik

